from agno.agent import Agent
from agno.models.openai import OpenAILike
from agno.run.team import TeamRunOutput
from agno.team import Team
from loguru import logger

import core.config

model = OpenAILike(
    id = core.config.settings.ai.model_id,
    api_key = core.config.settings.ai.api_key,
    base_url = core.config.settings.ai.base_url,
    temperature = 0.1,
)

# 写手
writer = Agent(
    name = "写手",
    role = "writer",
    model = model,
    instructions = [core.config.settings.ai.prompt],
)

# 去AI风格节点
de_ai = Agent(
    name = "去AI风格",
    role = "de_ai",
    model = model,
    instructions = [
        """
你是一个文本自然化专家，负责把生成的读后感去掉一切 AI 风格，确保输出更像真人写作。
要求：
1. 去掉模板化、抽象或公式化句子。
2. 删除任何关于 AI、模型、生成、机器人等的内容。
3. 保留原文的观点、反思和逻辑。
4. 口语化、自然化处理，必要时加入生活化细节。
5. 不增加无关信息。
6. 输出可直接发布的纯文本。
"""
    ]
)

# 审核
auditor = Agent(
    name = "审核",
    role = "auditor",
    model = model,
    instructions = [
        """
# 角色：
你是一个内容审核/润色助手，接收到一篇 AI 生成的读后感，请检查并进行必要的调整。  

# 目标：
1. 确保文本自然、真实、有个人感受，不出现任何 AI 风格或自称 AI 的表述。
2. 保留原文核心观点和反思，但必要时用更自然的口吻改写。
3. 不增加无关信息，不删除主要观点，只对语言和风格进行优化。
4. 输出必须像一个真人读者写的读后感，加入生活化或情感化细节。
5. 不增加无关信息，不删除主要观点，只调整语言和风格。

# 输出要求：
- 保持段落连贯
- 用第一人称或自然叙述，不出现“作为 AI 我认为”之类提示
- 修正过于抽象、空洞或公式化的句子
- 保留原文的思考与反思
- 输出为可直接发布的读后感
- 不能出现任何AI生成的痕迹
- 以纯文本形式输出
- 不要分段，不要换行、空行
- 使用第一人称或自然叙述
- 不提及书名或作者
- 保持语气流畅、自然、生动
- 可以适度加入修辞、停顿或口语化表达，但不要改变原意
    """
    ]
)

team = Team(
    name = "Content Team",
    members = [writer, de_ai, auditor],
    instructions = "You are a team of writers and auditors that work together to create high-quality content.",
    system_message = core.config.settings.ai.prompt,
    model = model,
    show_members_responses = True,
)


def run(book_info: str) -> str:
    response: TeamRunOutput = team.run(input = book_info)

    answer = response.content.replace('\n', '')
    logger.info(f'Content Team answer: {answer}')
    return answer


if __name__ == '__main__':
    answer = run(book_info =
                 """
                 “触动碎片”能够与自身紧密结合，慢慢变成自己的一部分，最终织出一张属于自己的认知网络。
         
         体系的本质就是用独特的视角将一些零散的、独立的知识、概念或观点整合为应对这个世界的方法和技巧。我们再走近一点观察，就会发现每个人的认知体系都是不同的，高手们也是根据自己的关注点，不断收集该领域内触动自己的信息，然后加工整合，形成独特的认知体系。所以，我们也要尝试建立独一无二的认知体系。
         
         这就是搭建个人认知体系的真相：打碎各家的认知体系，只取其中最触动自己的点或块，然后将其拼接成自己的认知网络。
         
         想通了这些，我们就能明白，为什么读了一些优质书、报了一些高端课，自己却无法发生想象中的巨变？因为那些书的目录、那些课程的大纲，虽然洋溢着体系的香味，但它们可能与自己的认知和需求贴合得并不紧密，学了也用不起来。明白了这些，我们就不会被各类体系所迷惑，不会因读完一本书而没有全部记住书中内容而内疚自责。
         
         随着我们自身认知体系的不断完善，原来距离我们较远的知识就会相对变近，于是又能触动我们，所以暂时放弃一些知识并不可怕，只要持续学习，我们不会损失什么。从这个角度看，我们已经能打破形式，从万事万物中学习了——只要学的东西是能触动自己并解决实际问题的，不管是读书、上课，还是自我反思或与人交谈，都是贴近自己的成长方式。这样成长不仅高效，而且非常“接地气”，甚至能消除学习的焦虑。
         
         有了触动，学习的机会就来了！
         
         触动是最好的筛选器
         
         我们潜意识的感性能力完全可以作为学习的筛选器——通过情绪触动，识别与自身需求结合最紧密的内容。紧紧地抓住这些内容就可以让自己处在舒适区的边缘，高效学习、快速提升。
         
         截至目前，似乎还没有人归纳过这种方法，所以我把它命名为“触动学习法”。通过运用“触动学习法”，我也得到了莫大的好处，用它来读书、反思、建立个人认知体系，效果非常显著。
         
         我建议每一个想成长的人都去进行每日反思，因为它可以提高自己对生活细节的感知能力，不会让日子像流水一样哗哗流过而什么都没留下。不过，和一般的日志不同，每日反思不是记流水账，而是留意每天最触动自己的那件事，不管是好的启发还是坏的体验，都写下来复盘，写得越细越好。一个触动点若是能转化成一个认知晶体，我们的生命质量和密度将远远超过那些不反思的人。面对生活中信息的滚滚洪流，触动真是最好的筛选器，它能让我们免受洪流的冲击，从容而体面地行走在人间。
         
         仅仅触动还不够
         
         不是所有的触动都是有效的。就像你曾经看过很多好文章，当时被触动得一塌糊涂，还把它们放进了收藏夹，但一段时间之后，你就再也记不起来了。如果让你在一本书上画出令自己触动的地方，纸页上可能会有很多横线，但显然这些内容不能全部为你所用。触动了却用不了，这就好像在医药箱里备了创可贴，可真到划破手指的时候却又想不起来用，这和没触动又有什么区别呢？
         
         确实没区别，因为它们只是“伪触动”。我们看看图5-7就明白其中的缘由了。
         
         
         
         图5-7　产生“触动”不意味着“连接”紧密
         
         当一个新知识靠近我们认知圈边缘的时候，触动产生了，但触动产生并不意味着连接紧密。如果不及时强化，新的触动点很可能停留一段时间之后就又“飞走了”。为了留住它，让它成为自己体系的一部分，就得想办法和它发生关系，产生连接。这种连接越多越好，但主要表现在以下三个方面（见图5-8）。
         
         
         
         图5-8　有效关联新知识的三个方面
         
         一是用自己的语言重新解释新知识，这会促使自己原有的知识体系对新知识做出反应。如果能用自己的语言把一个知识、一个道理、一件事情说清楚，让外行人也能听懂，那么这些知识、道理、事情十有八九会成为自己的一部分。经常输出的人往往成长得很快，因为他们总是不断在新旧知识之间建立连接。
         
         二是在需要的时候能够顺利提取知识，提取不出来的知识就是伪触动。比如我经常听罗振宇的60秒语音分享，但我在写作时，能从那些60秒语音分享中提取出来的观点只占少数，大多数观点都被我忘了。偶尔回头再看那些观点，我会感叹：这些知识很有道理啊，但我怎么就一点印象都没有了呢？像这种当时很受触动，但需要用的时候完全想不起来的知识，就是“伪触动”。说明它们离我们的真实需求很远，所以放弃也罢。
         
         如果你在读书、写作、交谈的时候想到了一个观点，哪怕你记不清具体的内容，只有一条微弱的线索，你也要极端重视这些内容，因为那些能在需要的时候被提取的知识，是与你真正产生触动的知识，你们之间宝贵的连接还在，所以要想办法主动关联和强化。
         
         很多人读书的时候往往只关注自己是否理解了书中的内容，却经常忽视头脑中冒出的想法。其实这些想法是非常珍贵的，放过了它们，我们的学习效果就会大打折扣。
         
         三是在生活中能够经常练习或使用这些知识，因为实践是产生强关联的终极方法。学习不是为了知道，而是为了发生真实的改变。当你运用那些知识践行那些道理时，相关细节就会源源不断地显现在你的视野里。到那时，你不仅能成为认知上的强者，也会成为行动上的巨人。
         
         最终，你会明白，所谓的学习成长，诸如阅读、写作、反思、培养习惯、练习技能、建立认知体系，等等，本质上都是一回事：在舒适区边缘，一点一点向外扩展。
         
         想通了这一点后，一切就都简单了！
         
                 """
                 )

    print(answer)
    print(answer.replace('\n', ''))
